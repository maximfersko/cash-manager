
services:

  database-postgres:
    image: postgres:15
    container_name: database_postgres
    restart: always
    ports:
      - "${POSTGRES_PORT}:5432"
    environment:
      POSTGRES_DB: ${POSTGRES_DATABASE}
      POSTGRES_USER: ${POSTGRES_USERNAME}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    env_file:
      - .env
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U ${POSTGRES_USERNAME} -d ${POSTGRES_DATABASE}" ]
      interval: 5s
      timeout: 5s
      retries: 20
      start_period: 10s


  migration:
    image: liquibase/liquibase:4.25
    container_name: migration
    volumes:
      - ./infrastructure/database/migration/changelog:/liquibase/changelog
    environment:
      LIQUIBASE_CHANGELOG_FILE: changelog-master.yaml
      LIQUIBASE_URL: jdbc:postgresql://database-postgres:5432/${POSTGRES_DATABASE}
      LIQUIBASE_USERNAME: ${POSTGRES_USERNAME}
      LIQUIBASE_PASSWORD: ${POSTGRES_PASSWORD}
      LIQUIBASE_SEARCH_PATH: /liquibase/changelog
    command:
      - --changelog-file=changelog-master.yaml
      - --url=jdbc:postgresql://database-postgres:5432/${POSTGRES_DATABASE}
      - --username=${POSTGRES_USERNAME}
      - --password=${POSTGRES_PASSWORD}
      - --search-path=/liquibase/changelog
      - update
    depends_on:
      database-postgres:
        condition: service_healthy

  frontend-dev:
    image: node:20-alpine
    container_name: cash-manager-frontend-dev
    working_dir: /app
    env_file:
      - .env
    environment:
      - VITE_KEYCLOAK_URL=http://localhost:${KEYCLOAK_HTTP_PORT}
      - VITE_KEYCLOAK_REALM=${KEYCLOAK_REALM}
      - VITE_KEYCLOAK_CLIENT_ID=${KEYCLOAK_CLIENT_ID}
    volumes:
      - ./frontend:/app
      - /app/node_modules
    ports:
      - "5173:5173"
    command: sh -c "npm ci || npm i && npm run dev"
    depends_on:
      - database-postgres
      - keycloak

  frontend-build:
    image: node:20-alpine
    container_name: cash-manager-frontend-build
    working_dir: /app
    env_file:
      - .env
    environment:
      - VITE_KEYCLOAK_URL=http://localhost:${KEYCLOAK_HTTP_PORT}
      - VITE_KEYCLOAK_REALM=${KEYCLOAK_REALM}
      - VITE_KEYCLOAK_CLIENT_ID=${KEYCLOAK_CLIENT_ID}
    volumes:
      - ./frontend:/app
      - frontend_dist:/app/dist
    command: sh -c "npm ci || npm i && npm run build"
    depends_on:
      database-postgres:
        condition: service_started
      keycloak:
        condition: service_started
    profiles:
      - production

  nginx:
    image: nginx:1.27-alpine
    container_name: cash-manager-nginx
    env_file:
      - .env
    environment:
      - API_SERVICE_HOST=${API_SERVICE_HOST:-backend-api}
      - API_SERVICE_PORT=${API_SERVICE_PORT:-8080}
    ports:
      - "8080:80"
    volumes:
      - frontend_dist:/usr/share/nginx/html:ro
      - ./frontend/nginx.conf:/etc/nginx/nginx.conf.template:ro
    command: /bin/sh -c "envsubst '$$API_SERVICE_HOST $$API_SERVICE_PORT' < /etc/nginx/nginx.conf.template > /etc/nginx/nginx.conf && nginx -g 'daemon off;'"
    depends_on:
      - frontend-build
    profiles:
      - production

  finance-service:
    build:
      context: finance-service
      dockerfile: Dockerfile
    container_name: finance-service
    ports:
      - "8092:8092"
    env_file:
      - .env
    environment:
      - SPRING_DATASOURCE_URL=jdbc:postgresql://database-postgres:5432/${POSTGRES_DATABASE}
      - SPRING_DATASOURCE_USERNAME=${POSTGRES_USERNAME}
      - SPRING_DATASOURCE_PASSWORD=${POSTGRES_PASSWORD}
      - SPRING_DATASOURCE_DRIVER_CLASS_NAME=org.postgresql.Driver
    depends_on:
      database-postgres:
        condition: service_healthy
      migration:
        condition: service_completed_successfully

  keycloak-db:
    image: postgres:15
    container_name: keycloak_postgres
    restart: always
    ports:
      - "${KEYCLOAK_DB_PORT}:5432"
    environment:
      POSTGRES_DB: ${KEYCLOAK_DB_NAME}
      POSTGRES_USER: ${KEYCLOAK_DB_USER}
      POSTGRES_PASSWORD: ${KEYCLOAK_DB_PASSWORD}
    env_file:
      - .env
    volumes:
      - keycloak_db_data:/var/lib/postgresql/data
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U ${KEYCLOAK_DB_USER} -d ${KEYCLOAK_DB_NAME}" ]
      interval: 5s
      timeout: 5s
      retries: 20
      start_period: 10s

  keycloak:
    image: quay.io/keycloak/keycloak:${KEYCLOAK_VERSION}
    container_name: keycloak
    command: start-dev
    restart: always
    ports:
      - "${KEYCLOAK_HTTP_PORT}:8080"
      - "${KEYCLOAK_HTTPS_PORT}:8443"
    env_file:
      - .env
    environment:
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://keycloak-db:5432/${KEYCLOAK_DB_NAME}
      KC_DB_USERNAME: ${KEYCLOAK_DB_USER}
      KC_DB_PASSWORD: ${KEYCLOAK_DB_PASSWORD}
      KEYCLOAK_ADMIN: ${KEYCLOAK_ADMIN_USER}
      KEYCLOAK_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD}
      KC_HTTP_ENABLED: ${KEYCLOAK_HTTP_ENABLED}
      KC_HTTP_PORT: 8080
      KC_HOSTNAME: ${KEYCLOAK_HOSTNAME}
      KC_HOSTNAME_PORT: ${KEYCLOAK_HTTP_PORT}
      KC_HOSTNAME_STRICT: ${KEYCLOAK_HOSTNAME_STRICT}
      KC_HOSTNAME_STRICT_HTTPS: ${KEYCLOAK_HOSTNAME_STRICT_HTTPS}
    depends_on:
      keycloak-db:
        condition: service_healthy

  auth-service:
    build:
      context: auth-service
      dockerfile: Dockerfile
    container_name: auth-service
    ports:
      - "8082:8082"
    env_file:
      - .env
    environment:
      - AUTH_SERVICE_PORT=8082
      - SPRING_DATASOURCE_URL=jdbc:postgresql://database-postgres:5432/${POSTGRES_DATABASE}
      - SPRING_DATASOURCE_USERNAME=${POSTGRES_USERNAME}
      - SPRING_DATASOURCE_PASSWORD=${POSTGRES_PASSWORD}
      - KEYCLOAK_ISSUER_URI=http://keycloak:8080/realms/${KEYCLOAK_REALM}
      - KEYCLOAK_JWK_SET_URI=http://keycloak:8080/realms/${KEYCLOAK_REALM}/protocol/openid-connect/certs
      - KEYCLOAK_SERVER_URL=http://keycloak:8080
      - KEYCLOAK_REALM=${KEYCLOAK_REALM}
      - KEYCLOAK_ADMIN_CLIENT_ID=${KEYCLOAK_ADMIN_CLIENT_ID}
      - KEYCLOAK_ADMIN_CLIENT_SECRET=${KEYCLOAK_ADMIN_CLIENT_SECRET}
      - KEYCLOAK_ADMIN_USER=${KEYCLOAK_ADMIN_USER}
      - KEYCLOAK_ADMIN_PASSWORD=${KEYCLOAK_ADMIN_PASSWORD}
      - KEYCLOAK_CLIENT_ID=${KEYCLOAK_CLIENT_ID}
      - KEYCLOAK_CLIENT_SECRET=${KEYCLOAK_CLIENT_SECRET}
    depends_on:
      database-postgres:
        condition: service_healthy
      migration:
        condition: service_completed_successfully
      keycloak:
        condition: service_started

  infisical-db:
    image: postgres:15
    container_name: infisical_postgres
    restart: always
    environment:
      POSTGRES_DB: infisical
      POSTGRES_USER: infisical
      POSTGRES_PASSWORD: infisical
    volumes:
      - infisical_db_data:/var/lib/postgresql/data
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U infisical -d infisical" ]
      interval: 5s
      timeout: 5s
      retries: 20
      start_period: 10s

  infisical:
    image: infisical/infisical:latest
    container_name: infisical
    restart: unless-stopped
    ports:
      - "3000:8080"
    depends_on:
      redis:
        condition: service_started
      infisical-db:
        condition: service_healthy
    environment:
      AUTH_SECRET: "f3c6c23129d0f4b5c0e8294bf51e0c2abfb3e4d7a9c61c4f5e8a1d7b2c4e6f8a"
      ENCRYPTION_KEY: "0123456789abcdef0123456789abcdef"
      ROOT_ENCRYPTION_KEY: "0123456789abcdef0123456789abcdef"
      SITE_URL: "http://localhost:3000"
      REDIS_URL: "redis://redis:6379"
      DATABASE_URL: "postgresql://infisical:infisical@infisical-db:5432/infisical"
      DB_CONNECTION_URI: "postgresql://infisical:infisical@infisical-db:5432/infisical"
      POSTGRES_HOST: "infisical-db"
      POSTGRES_USER: "infisical"
      POSTGRES_PASSWORD: "infisical"
      POSTGRES_DB: "infisical"
      POSTGRES_PORT: "5432"

  redis:
    image: redis:7
    container_name: redis
    restart: unless-stopped

volumes:
  postgres_data:
  frontend_dist:
  keycloak_db_data:
  infisical_db_data:
